<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="“无感”就是最棒的设计

问题想直接解决问题不愿听故事的，进屋坐坐看第二节。
最近在公司领到一个任务，优化公司的缓存框架的使用体验。公司的缓存框架封装成一个JAR文件，提供基于注解的对几种缓存的一致性使用。覆盖的缓存方案有ehcache memcached redis，先向公司大牛致敬。要使用缓存框架，需要做这么几件事：

引入缓存框架的JAR文件

引入想要使用的缓存JAR，比如memcach">
<meta property="og:type" content="article">
<meta property="og:title" content="参照SpringBoot的自动配置">
<meta property="og:url" content="http://dm4157.github.io/2016/07/14/boot1/index.html">
<meta property="og:site_name" content="蝉羽">
<meta property="og:description" content="“无感”就是最棒的设计

问题想直接解决问题不愿听故事的，进屋坐坐看第二节。
最近在公司领到一个任务，优化公司的缓存框架的使用体验。公司的缓存框架封装成一个JAR文件，提供基于注解的对几种缓存的一致性使用。覆盖的缓存方案有ehcache memcached redis，先向公司大牛致敬。要使用缓存框架，需要做这么几件事：

引入缓存框架的JAR文件

引入想要使用的缓存JAR，比如memcach">
<meta property="og:updated_time" content="2017-07-25T06:55:35.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="参照SpringBoot的自动配置">
<meta name="twitter:description" content="“无感”就是最棒的设计

问题想直接解决问题不愿听故事的，进屋坐坐看第二节。
最近在公司领到一个任务，优化公司的缓存框架的使用体验。公司的缓存框架封装成一个JAR文件，提供基于注解的对几种缓存的一致性使用。覆盖的缓存方案有ehcache memcached redis，先向公司大牛致敬。要使用缓存框架，需要做这么几件事：

引入缓存框架的JAR文件

引入想要使用的缓存JAR，比如memcach">
    
    
        
          
              <link rel="shortcut icon" href="/images/my.jpg">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/my.jpg" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/my.jpg">
          
        
    
    <!-- title -->
    <title>参照SpringBoot的自动配置</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- rss -->
    
    
</head>

<body>
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2016/08/06/mybatis1/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li>
        
        
        <li><a class="icon" href="/2016/06/02/java3/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li>
        <li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://dm4157.github.io/2016/07/14/boot1/"><i class="fa fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://dm4157.github.io/2016/07/14/boot1/&text=参照SpringBoot的自动配置"><i class="fa fa-twitter " aria-hidden="true"></i></a></li>
  <li class="icon bdsharebuttonbox"><a href="javascript:void(0)" data-cmd="weixin" id="wexin" class="fa fa-comments bds_weixin" aria-hidden="true"></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://dm4157.github.io/2016/07/14/boot1/&title=参照SpringBoot的自动配置"><i class="fa fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=参照SpringBoot的自动配置&body=Check out this article: http://dm4157.github.io/2016/07/14/boot1/"><i class="fa fa-envelope " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#问题"><span class="toc-number">1.</span> <span class="toc-text">问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#终焉"><span class="toc-number">2.</span> <span class="toc-text">终焉</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#赘述"><span class="toc-number">3.</span> <span class="toc-text">赘述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#有条件的创建"><span class="toc-number">3.1.</span> <span class="toc-text">有条件的创建</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#注解-Conditional"><span class="toc-number">3.1.1.</span> <span class="toc-text">注解 @Conditional</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#接口-Condition"><span class="toc-number">3.1.2.</span> <span class="toc-text">接口 Condition</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#参数-ConditionContext"><span class="toc-number">3.1.2.1.</span> <span class="toc-text">参数 ConditionContext</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#AnnotatedTypeMetadata"><span class="toc-number">3.1.2.2.</span> <span class="toc-text">AnnotatedTypeMetadata</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#尝试自动配置"><span class="toc-number">3.2.</span> <span class="toc-text">尝试自动配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#判断条件"><span class="toc-number">3.2.1.</span> <span class="toc-text">判断条件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#编写自动配置类"><span class="toc-number">3.2.2.</span> <span class="toc-text">编写自动配置类</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#赘述2-0"><span class="toc-number">4.</span> <span class="toc-text">赘述2.0</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#问题1-配置文件"><span class="toc-number">4.1.</span> <span class="toc-text">问题1.配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#问题2-自动配置的类加载"><span class="toc-number">4.2.</span> <span class="toc-text">问题2.自动配置的类加载</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Configuration"><span class="toc-number">4.2.1.</span> <span class="toc-text">@Configuration</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#component-scan"><span class="toc-number">4.2.2.</span> <span class="toc-text">component-scan</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用Selector加载Bean"><span class="toc-number">4.2.3.</span> <span class="toc-text">使用Selector加载Bean</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#编写我们的ImportSelector"><span class="toc-number">4.2.4.</span> <span class="toc-text">编写我们的ImportSelector</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用-Import注册Bean"><span class="toc-number">4.2.5.</span> <span class="toc-text">使用@Import注册Bean</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#结语"><span class="toc-number">5.</span> <span class="toc-text">结语</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PS"><span class="toc-number">6.</span> <span class="toc-text">PS:</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Memchached配置辅助类"><span class="toc-number">6.0.1.</span> <span class="toc-text">Memchached配置辅助类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Memcached自动配置类"><span class="toc-number">6.0.2.</span> <span class="toc-text">Memcached自动配置类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Redis配置辅助类"><span class="toc-number">6.0.3.</span> <span class="toc-text">Redis配置辅助类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Redis自动配置类"><span class="toc-number">6.0.4.</span> <span class="toc-text">Redis自动配置类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ImportSelector"><span class="toc-number">6.0.5.</span> <span class="toc-text">ImportSelector</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ConditionalOnClass"><span class="toc-number">6.0.6.</span> <span class="toc-text">ConditionalOnClass</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#OnClassCondition"><span class="toc-number">6.0.7.</span> <span class="toc-text">OnClassCondition</span></a></li></ol></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index width mx-auto px2 my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        参照SpringBoot的自动配置
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">殇月陨</span>
      </span>
      
    <div class="postdate">
        <time datetime="2016-07-14T01:50:21.000Z" itemprop="datePublished">2016-07-14</time>
    </div>


      
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/boot/">boot</a>, <a class="tag-link" href="/tags/java/">java</a>, <a class="tag-link" href="/tags/spring/">spring</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <blockquote>
<p>“无感”就是最棒的设计</p>
</blockquote>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p><del>想直接解决问题不愿听故事的，进屋坐坐看第二节。</del></p>
<p>最近在公司领到一个任务，优化公司的缓存框架的使用体验。公司的缓存框架封装成一个JAR文件，提供基于注解的对几种缓存的一致性使用。覆盖的缓存方案有<code>ehcache</code> <code>memcached</code> <code>redis</code>，先向公司大牛致敬。<br>要使用缓存框架，需要做这么几件事：</p>
<ol>
<li><p>引入缓存框架的JAR文件</p>
</li>
<li><p>引入想要使用的缓存JAR，比如memcached.jar</p>
</li>
<li><p>做相关的Spring Bean配置，比如要使用Memcached缓存就要有如下的配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- memcache配置示例 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">name</span>=<span class="string">"ljmemcachedClient"</span> <span class="attr">class</span>=<span class="string">"net.rubyeye.xmemcached.utils.XMemcachedClientFactoryBean"</span> <span class="attr">destroy-method</span>=<span class="string">"shutdown"</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 多个地址空格分隔 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"servers"</span> <span class="attr">value</span>=<span class="string">"$&#123;cache.memcacheAddress&#125;"</span> /&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 连接池大小一般5已经足够用,根据项目组实际情况调整 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"connectionPoolSize"</span> <span class="attr">value</span>=<span class="string">"$&#123;cache.memcachePoolSize&#125;"</span> /&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 一致哈希分布 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"sessionLocator"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"net.rubyeye.xmemcached.impl.KetamaMemcachedSessionLocator"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 二进制协议,提高数据传输效率,支持touch等 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"commandFactory"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"net.rubyeye.xmemcached.command.BinaryCommandFactory"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>必要的配置文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cache.memcacheAddress=10.8.1.107:11211</span><br><span class="line">cache.memcachePoolSize=1</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>如果要使用redis缓存，则要引入另外一套配置。每个新项目都要配置，这显然是令人沮丧的。能不能简化这些配置呢？</p>
<ul>
<li>方案一：在<em>缓存框架</em>中引入三种缓存的JAR包，并做三种缓存的<code>Bean</code>配置，不提供配置文件，由使用<em>缓存框架</em>的项目提供。</li>
<li>方案二：在<em>缓存框架</em>中提供三种缓存的“自动配置”，由使用<em>缓存框架</em>的项目提供配置文件和相关缓存JAR包，根据引入的缓存JAR包“自动配置”适合的<code>Bean</code>对象，完成缓存的使用。</li>
</ul>
<p>来看下两种方案的优缺：</p>
<ul>
<li>方案一<ul>
<li>优点：简单易实现</li>
<li>缺点：JAR包臃肿，无论实际使用哪种缓存，都引入了三种缓存JAR，并且需要提供三种的配置文件。不符合程序员美学–简约</li>
</ul>
</li>
<li>方案二：<ul>
<li>优点：“智能”发现缓存，按需引入，语义明确，使用方便</li>
<li>缺点：程序实现复杂</li>
</ul>
</li>
</ul>
<p>我选择<strong>方案二</strong>。</p>
<p>然而<strong>Spring Boot</strong> 已经有成熟的自动配置实现方案，如果直接引入 <em>spring-boot-autoconfigure.jar</em> 会面临额外问题：</p>
<ol>
<li><em>spring-boot-autoconfigure.jar</em> 没有“直接”提供针对 <code>memcahced</code> 的自动配置；</li>
<li><em>spring-boot-autoconfigure.jar</em> 提供了太多自动配置支持，而我只想要关于缓存的几个；</li>
</ol>
<p>那就只好模仿<strong>Spring Boot</strong>搞一搞了。</p>
<hr>
<h2 id="终焉"><a href="#终焉" class="headerlink" title="终焉"></a>终焉</h2><blockquote>
<p>撒花…完结</p>
</blockquote>
<p>在开始赘述之前，先给出最终的成品。</p>
<p>如何使用自动配置？</p>
<ol>
<li><p>引入自动配置JAR包</p>
</li>
<li><p>使用注解 <code>@EnableAutoConfigure</code> 开启自动配置。建议写在基础类上或者专门提供一个类，如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableAutoConfigure</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AutoConfigure</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>根据需要选择具体缓存，引入JAR并给出配置信息。比如memcached.jar</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cache.memcached.servers=10.8.1.107:11211</span><br><span class="line">cache.memcached.connectionPoolSize=2</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>PS: 这里有一个纠结的地方，其实可以做到省略第2步，也就是在自动配置JAR包里把这事做了。但笔者感觉这样不好，好像是降低了使用的成本，但是损失了使用的自由。所以最终还是没有进一步封装。这里仅代表笔者个人感受，未必是对的。 </p>
<p>PS2：然而什么是对的呢？世界本来就不是0和1.</p>
<h2 id="赘述"><a href="#赘述" class="headerlink" title="赘述"></a>赘述</h2><p>接下来详细说说如何实现的。</p>
<h3 id="有条件的创建"><a href="#有条件的创建" class="headerlink" title="有条件的创建"></a>有条件的创建</h3><blockquote>
<p>除非满足条件，不然。。。哼！</p>
</blockquote>
<p>最本质的需求是根据条件加载Bean。 <code>Spring4</code> 提供了实现方案 — <code>@Conditional</code> ，可以通过条件判断创建 <code>Bean</code> 。</p>
<p>示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// java config</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestBeanConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据条件创建， 条件写在TestConditional类里</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Conditional</span>(TestConditional.class)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> TestBean <span class="title">createTestBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> TestBean();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配套的条件类实现</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestConditional</span> <span class="keyword">implements</span> <span class="title">Condition</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(ConditionContext context, AnnotatedTypeMetadata metadata)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>只有当 <code>TestConditional.matches()</code> 结果为 <strong>true</strong> 时才会创建 <code>TestBean</code> 。</p>
<h4 id="注解-Conditional"><a href="#注解-Conditional" class="headerlink" title="注解 @Conditional"></a>注解 @Conditional</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Target</span>(&#123;ElementType.TYPE, ElementType.METHOD&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Conditional &#123;</span><br><span class="line"></span><br><span class="line">    Class&lt;? extends Condition&gt;[] value();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>作用范围： 类，方法</li>
<li>包含参数： value, 接口<code>Condition</code>的实现类数组。数组内所有的条件都要满足哟！</li>
</ul>
<p>如果value中的条件都满足，就创建接下来的Bean。没啥好说的了；</p>
<h4 id="接口-Condition"><a href="#接口-Condition" class="headerlink" title="接口 Condition"></a>接口 Condition</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Condition</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当返回值为true时，创建Bean；否则忽略。</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(ConditionContext context, AnnotatedTypeMetadata metadata)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接口很简单只有一个matches方法，可以通过context和metadata获得相应判断信息，辅助判断；</p>
<h5 id="参数-ConditionContext"><a href="#参数-ConditionContext" class="headerlink" title="参数 ConditionContext"></a>参数 ConditionContext</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ConditionContext</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 检查Bean定义</span></span><br><span class="line">    <span class="function">BeanDefinitionRegistry <span class="title">getRegistry</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">// 检查Bean是否存在，甚至探查Bean的属性</span></span><br><span class="line">    <span class="function">ConfigurableListableBeanFactory <span class="title">getBeanFactory</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">// 检查环境变量是否存在以及它的值是什么</span></span><br><span class="line">    <span class="function">Environment <span class="title">getEnvironment</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">// 检查加载的资源</span></span><br><span class="line">    <span class="function">ResourceLoader <span class="title">getResourceLoader</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">// 加载并检查类是否存在</span></span><br><span class="line">    <span class="function">ClassLoader <span class="title">getClassLoader</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="AnnotatedTypeMetadata"><a href="#AnnotatedTypeMetadata" class="headerlink" title="AnnotatedTypeMetadata"></a>AnnotatedTypeMetadata</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AnnotatedTypeMetadata</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isAnnotated</span><span class="params">(String annotationName)</span></span>;</span><br><span class="line">    <span class="function">Map&lt;String, Object&gt; <span class="title">getAnnotationAttributes</span><span class="params">(String annotationName)</span></span>;</span><br><span class="line">    <span class="function">Map&lt;String, Object&gt; <span class="title">getAnnotationAttributes</span><span class="params">(String annotationName, <span class="keyword">boolean</span> classValuesAsString)</span></span>;</span><br><span class="line">    <span class="function">MultiValueMap&lt;String, Object&gt; <span class="title">getAllAnnotationAttributes</span><span class="params">(String annotationName)</span></span>;</span><br><span class="line">    <span class="function">MultiValueMap&lt;String, Object&gt; <span class="title">getAllAnnotationAttributes</span><span class="params">(String annotationName, <span class="keyword">boolean</span> classValuesAsString)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>借助 <code>isAnnotated()</code> 能够判断带有 <code>@Bean</code> 注解的方法是不是还有其他特定注解；</li>
<li>借助其他方法可以检查 <code>@Bean</code> 注解的方法上其他注解的属性；</li>
</ul>
<h3 id="尝试自动配置"><a href="#尝试自动配置" class="headerlink" title="尝试自动配置"></a>尝试自动配置</h3><h4 id="判断条件"><a href="#判断条件" class="headerlink" title="判断条件"></a>判断条件</h4><p>至此，基础技能已经 <em>GET</em> ，要解决第一节的问题，只要做判断：当前类路径下是否存在某类，有就创建无则忽略。<br><strong>Spring Boot</strong> 在 <code>@Conditional</code> 基础上扩展了几个注解方便做此类判断：<code>@ConditionalOnClass</code>,  <code>@ConditionalOnMissingClass</code> ,  <code>@ConditionalOnBean</code> ,  <code>@ConditionalOnMissingBean</code> ;<br>这里就不贴源码了，想看的朋友去这里 <strong>org.springframework.boot.autoconfigure.condition</strong>;<br>当然可以自行编写条件类实现判断，我这里就懒省事了，直接使用 <strong>Spring Boot</strong> 的实现。<del>（才没有这么简单）</del></p>
<h4 id="编写自动配置类"><a href="#编写自动配置类" class="headerlink" title="编写自动配置类"></a>编写自动配置类</h4><p>编写 <code>memcached</code> 和 <code>redis</code> 的Java Config类。核心代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * memcached 缓存自动配置</span><br><span class="line"> * 在引入googlecode-xmemcached.jar时启用</span><br><span class="line"> * Created by mw4157 on 16/7/6.</span><br><span class="line"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass</span>(MemcachedClient.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MemcachedAutoConfiguration</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 创建一个工厂Bean</span><br><span class="line">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> XMemcachedClientFactoryBean <span class="title">memcachedClientFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ...;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * redis 自动配置</span><br><span class="line"> * 在引入redis-clients.jar和spring-data-redis.jar时启用</span><br><span class="line"> * Created by mw4157 on 16/7/8.</span><br><span class="line"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass</span>(&#123; JedisConnection.class, RedisOperations.class, Jedis.class &#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisAutoConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Redis 连接配置</span><br><span class="line">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span>(RedisConnectionFactory.class)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> JedisConnectionFactory <span class="title">redisConnectionFactory</span><span class="params">()</span> <span class="keyword">throws</span> UnknownHostException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ...;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>代码的核心功能是创造需要的Bean，同时辅以<code>@Conditional</code>相关的注解，就可以在大意上解决问题。</p>
<h2 id="赘述2-0"><a href="#赘述2-0" class="headerlink" title="赘述2.0"></a>赘述2.0</h2><p>之所以说大意上，是因为还有其他内容没有注意到：</p>
<ol>
<li>如何将配置文件与自动配置类结合起来？</li>
<li><code>@Configuration</code> 注解本身继承于 <code>@Component</code> ，可以被 <strong>component-scan</strong> 扫描到，如果项目配置的扫描根路径范围过大包括了自动配置类，则可能会引发错误（这其实是不可避免的“缺陷”，读者可以尝试在自己的项目中扫描 <code>org.spring</code> 会发现项目无法启动）。以 <code>MemcachedAutoConfiguration</code> 为例，如果项目没有引入 <em>googlecode-xmemcached.jar</em>，这个类上的 <code>MemcachedClient.class</code> 一定是无法识别的，此时被 <strong>Spring</strong> 的 <strong>component-scan</strong> 直接扫描到，会在加载类（load class)阶段报错<em>NoClassDefFoundError</em>。</li>
</ol>
<h3 id="问题1-配置文件"><a href="#问题1-配置文件" class="headerlink" title="问题1.配置文件"></a>问题1.配置文件</h3><p><strong>Spring</strong> 提供了一个注解用于导入配置文件中的数据 —  <code>@Value</code> 。<br>基本用法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Value</span>(<span class="string">"$&#123;name&#125;"</span>)</span><br><span class="line"><span class="keyword">private</span> String address;</span><br><span class="line"><span class="meta">@Value</span>(<span class="string">"$&#123;name:defaultValue&#125;"</span>)</span><br><span class="line"><span class="keyword">private</span> String address2;</span><br></pre></td></tr></table></figure></p>
<p><code>name</code> 对应 <em>properties</em> 文件里的 <strong>key</strong> ; <code>defaultValue</code> 是参数的默认值，在 <strong>key</strong> 不存在时生效。有一点需要注意的是：如何默认null？<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Value</span>(<span class="string">"$&#123;name:null&#125;"</span>)</span><br></pre></td></tr></table></figure></p>
<p>这是不对的，注入的是字符串“null”，正确的做法是：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Value</span>(<span class="string">"$&#123;name:#&#123;null&#125;&#125;"</span>)</span><br></pre></td></tr></table></figure></p>
<h3 id="问题2-自动配置的类加载"><a href="#问题2-自动配置的类加载" class="headerlink" title="问题2.自动配置的类加载"></a>问题2.自动配置的类加载</h3><p>要解决问题2，首先要避免自动配置类被项目的 <strong>component-scan</strong> 直接发现，其次我们要在合适的时候让 <strong>Spring</strong> 发现自动配置类，并在加载前判断 <code>@Conditional</code> 是否满足，不满足就直接跳过。老实说，我没有信心说明白这个问题。</p>
<p>下面介绍几个相关知识点：</p>
<h4 id="Configuration"><a href="#Configuration" class="headerlink" title="@Configuration"></a>@Configuration</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Configuration &#123;</span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以注意到 <code>@Configuration</code> 是被 <code>@Component</code> 修饰的，所以可以被 <strong>component-scan</strong> 发现。</p>
<h4 id="component-scan"><a href="#component-scan" class="headerlink" title="component-scan"></a>component-scan</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 自动扫描且不扫描@Controller--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"org.msdg"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">context:exclude-filter</span> <span class="attr">type</span>=<span class="string">"annotation"</span> <span class="attr">expression</span>=<span class="string">"org.springframework.stereotype.Controller"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">context:exclude-filter</span> <span class="attr">type</span>=<span class="string">"annotation"</span> <span class="attr">expression</span>=<span class="string">"org.springframework.web.bind.annotation.ControllerAdvice"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">context:exclude-filter</span> <span class="attr">type</span>=<span class="string">"regex"</span> <span class="attr">expression</span>=<span class="string">"org.msdg.core.conf.autoconfigure.*"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">context:component-scan</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>Spring</strong> 会自动扫描 <em>base-package</em> 下的Java类，如果发现带有 <code>@Component</code> (包括用其修饰的注解 <code>@Repository</code>   <code>@Service</code>   <code>@Controller</code>   <code>@RestController</code>   <code>@Configuration</code> 等)的类，将会放入Spring容器中管理，成为众多Bean里的一员。<br><strong>component-scan</strong> 还包括两个子标签 <em><context:include-filter></context:include-filter></em> 和 <em><context:exclude-filter></context:exclude-filter></em> ,注意两个不是必须的，但如果同时出现，要保证 <em>include-filter</em> 出现在前面，并且如果范围重合，重合部分被后续的 <em>exclude-filter</em> 排除掉。两个子标签都具有 <code>type</code> 和 <code>expression</code> 两个属性：</p>
<ul>
<li>type<ul>
<li>annotation     拥有指定注解的类</li>
<li>aspectj            AspectJ语法</li>
<li>assignable     指定class或interface的全名</li>
<li>regex        表达式，可以写类似org.spring.*,org.spring包下的类都被包括</li>
<li>custom           Spring自定义类型，并没有研究过</li>
</ul>
</li>
<li>expression 就是表达式了，可以写全限定类名、符合规范的正则表达等</li>
</ul>
<p>在必要的时候可以通过 <em><context:exclude-filter></context:exclude-filter></em> 来避免扫描自动配置类。<del>但真要这么做的话只能说明 <strong>component-scan</strong> 的范围过大了，不够精细，不优雅。</del></p>
<h4 id="使用Selector加载Bean"><a href="#使用Selector加载Bean" class="headerlink" title="使用Selector加载Bean"></a>使用Selector加载Bean</h4><p>在避免了基础扫描后，我们要在适当的时候引入自动配置的类。这里需要用到接口 <code>DeferredImportSelector</code> 。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DeferredImportSelector</span> <span class="keyword">extends</span> <span class="title">ImportSelector</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这是一个典型的“标识型”接口，没有任何需要实现的方法。来看下官方注释：</p>
<blockquote>
<p>A variation of ImportSelector that runs after all @Configuration beans have been processed. This type of selector can be particularly useful when the selected imports are @Conditional.<br>Implementations can also extend the Ordered interface or use the Order annotation to indicate a precedence against other DeferredImportSelectors.</p>
</blockquote>
<p>大意是这个接口的实现类将会在 <code>@Configuration</code> 的Bean处理后执行。并且 <code>DeferredImportSelector</code> 是专门用来选择导入 <code>@Conditional</code> 修饰的Bean。我们也可以用 <code>@Ordered</code> 决定多个 <code>DeferredImportSelector</code> 的执行顺序。<br>突破口就在这里， 让我们更详尽的了解一下接口 <code>ImportSelector</code> 的作用。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ImportSelector</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Select and return the names of which class(es) should be imported based on</span><br><span class="line">     * the &#123;<span class="doctag">@link</span> AnnotationMetadata&#125; of the importing @&#123;<span class="doctag">@link</span> Configuration&#125; class.</span><br><span class="line">     */</span></span><br><span class="line">    String[] selectImports(AnnotationMetadata importingClassMetadata);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>根据 <em>importingClassMetadata</em> 的值，从带有注解 <code>@Configuration</code> 的类中选择并返回合适的类命名数组，将其导入 <strong>Spring</strong> 容器。执行顺序是在 <code>@Configuration</code> 引入的Bean处理之后。接口 <code>ImportSelector</code> 的作用类似于注解 <code>@Import</code> 。</p>
<p>一个 <code>ImportSelector</code> 通常应该实现任意一个或多个 <code>Aware</code> 接口，比如：</p>
<ul>
<li><code>EnvironmentAware</code></li>
<li><code>BeanFactoryAware</code></li>
<li><code>BeanClassLoaderAware</code></li>
<li><code>ResourceLoaderAware</code></li>
</ul>
<h4 id="编写我们的ImportSelector"><a href="#编写我们的ImportSelector" class="headerlink" title="编写我们的ImportSelector"></a>编写我们的<code>ImportSelector</code></h4><p><del>参考了Spring Boot的实现，哦哈哈，别告我抄袭</del><br><em>代码是部分代码，完全体见文章结尾</em><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Order</span>(Ordered.LOWEST_PRECEDENCE - <span class="number">1</span>)</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EnableAutoConfigurationImportSelector</span> <span class="keyword">implements</span> <span class="title">DeferredImportSelector</span>,</span><br><span class="line">		<span class="title">BeanClassLoaderAware</span>, <span class="title">ResourceLoaderAware</span>, <span class="title">BeanFactoryAware</span>, <span class="title">EnvironmentAware</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> String[] selectImports(AnnotationMetadata metadata) &#123;</span><br><span class="line">		List&lt;String&gt; configurations = getCandidateConfigurations();</span><br><span class="line">		configurations = removeDuplicates(configurations);</span><br><span class="line">		<span class="keyword">return</span> configurations.toArray(<span class="keyword">new</span> String[configurations.size()]);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span><br><span class="line">	 * 核心方法,引入需要的类</span><br><span class="line">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> List&lt;String&gt; <span class="title">getCandidateConfigurations</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> SpringFactoriesLoader.loadFactoryNames(<span class="keyword">this</span>.getClass(), getBeanClassLoader());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span><br><span class="line">	 * 删除重复引用</span><br><span class="line">	 */</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">final</span> &lt;T&gt; <span class="function">List&lt;T&gt; <span class="title">removeDuplicates</span><span class="params">(List&lt;T&gt; list)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> ArrayList&lt;T&gt;(<span class="keyword">new</span> LinkedHashSet&lt;T&gt;(list));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>为了方便多方面装配，四大接口全部实现了，<del>但这不重要</del>。核心方法是 <em>getCandidateConfigurations()</em> ，通过 <code>SpringFactoriesLoader</code> 加载自动配置类。<strong>Spring Boot</strong> 是这么用的，不要问我为什么，我也不知道有没有别的替代方案。T_T<br><code>SpringFactoriesLoader</code> 会加载并实例化写在文件 “META-INF/spring.factories” 中的类。<em>key-value</em> 形式，需要写清全限定类名。根据官方解释是用来表达工厂类和多种实现类的管理，应该是类似父子关系，但这里并没有强制限定。所以，我们的 <strong>spring.factories</strong> 是这样的：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># Auto Configure</span><br><span class="line">org.msdg.core.conf.autoconfigure.EnableAutoConfigurationImportSelector=\</span><br><span class="line">  org.msdg.core.conf.autoconfigure.memcached.MemcachedAutoConfiguration,\</span><br><span class="line">  org.msdg.core.conf.autoconfigure.redis.RedisAutoConfiguration</span><br></pre></td></tr></table></figure></p>
<p>至此突破口已经准备好了。</p>
<h4 id="使用-Import注册Bean"><a href="#使用-Import注册Bean" class="headerlink" title="使用@Import注册Bean"></a>使用@Import注册Bean</h4><p>现在只需要将 <code>ImportSelector</code> 放入Spring容器中就可以了。<br>因此我们要引入 <code>@Import</code> , 这个注解可以导入一个配置类到另一个配置类中。在 <strong>Spring4.2</strong> 中对这个注解进行了加强，可以直接将一个类加入Spring容器。那么只要写上 <em>@Import(EnableAutoConfigurationImportSelector.class)</em> 即可。<br>为了便于使用，这里自定义一个注解：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Import</span>(EnableAutoConfigurationImportSelector.class)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableAutoConfigure &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>先告一段落吧。如有表述不清，欢迎讨论。</p>
<h2 id="PS"><a href="#PS" class="headerlink" title="PS:"></a>PS:</h2><h4 id="Memchached配置辅助类"><a href="#Memchached配置辅助类" class="headerlink" title="Memchached配置辅助类"></a>Memchached配置辅助类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by mw4157 on 16/7/9.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MemcachedProperties</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;cache.memcached.servers:localhost&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String servers;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;cache.memcached.connectionPoolSize:1&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> connectionPoolSize;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;cache.memcached.sessionLocatorKind:ketama&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String sessionLocatorKind;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;cache.memcached.commandFactory:binary&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String commandFactory;</span><br><span class="line">	</span><br><span class="line">  	<span class="comment">// getter and setter</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Memcached自动配置类"><a href="#Memcached自动配置类" class="headerlink" title="Memcached自动配置类"></a>Memcached自动配置类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.msdg.core.cache.impl.MemCacheManager;</span><br><span class="line"><span class="keyword">import</span> org.msdg.core.conf.autoconfigure.condition.ConditionalOnMissingBean;</span><br><span class="line"><span class="keyword">import</span> net.rubyeye.xmemcached.MemcachedClient;</span><br><span class="line"><span class="keyword">import</span> net.rubyeye.xmemcached.command.BinaryCommandFactory;</span><br><span class="line"><span class="keyword">import</span> net.rubyeye.xmemcached.command.KestrelCommandFactory;</span><br><span class="line"><span class="keyword">import</span> net.rubyeye.xmemcached.command.TextCommandFactory;</span><br><span class="line"><span class="keyword">import</span> net.rubyeye.xmemcached.impl.ArrayMemcachedSessionLocator;</span><br><span class="line"><span class="keyword">import</span> net.rubyeye.xmemcached.impl.ElectionMemcachedSessionLocator;</span><br><span class="line"><span class="keyword">import</span> net.rubyeye.xmemcached.impl.KetamaMemcachedSessionLocator;</span><br><span class="line"><span class="keyword">import</span> net.rubyeye.xmemcached.utils.XMemcachedClientFactoryBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.msdg.core.conf.autoconfigure.condition.ConditionalOnClass;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * memcached 缓存自动配置</span><br><span class="line"> * 当类路径中存在MemcachedClient.class时,加载配置</span><br><span class="line"> * Created by mw4157 on 16/7/6.</span><br><span class="line"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass</span>(MemcachedClient.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MemcachedAutoConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * memcached配置实体</span><br><span class="line">     * 用于引入相关的配置, 具体参见 &#123;<span class="doctag">@link</span> MemcachedProperties&#125;</span><br><span class="line">     */</span></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"org.msdg.core.conf.autoconfigure.cache.MemcachedProperties"</span>)</span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MemcachedProperties <span class="title">memcachedProperties</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MemcachedProperties();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 抽象配置memcahced的逻辑</span><br><span class="line">     * 具体配置可继承此类</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractMemcachedConfiguration</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Autowired</span></span><br><span class="line">        <span class="keyword">private</span> MemcachedProperties properties;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span><br><span class="line">         * 应用配置信息, 创建工厂类</span><br><span class="line">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> XMemcachedClientFactoryBean <span class="title">applyProperties</span><span class="params">(XMemcachedClientFactoryBean clientFactory)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// 设置服务器</span></span><br><span class="line">            clientFactory.setServers(properties.getServers());</span><br><span class="line">            <span class="comment">// 连接池大小一般5已经足够用,根据项目组实际情况调整</span></span><br><span class="line">            clientFactory.setConnectionPoolSize(properties.getConnectionPoolSize());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 分布策略</span></span><br><span class="line">            <span class="keyword">switch</span> (properties.getSessionLocatorKind()) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">"ketama"</span>:</span><br><span class="line">                    <span class="comment">// 一致性哈希(默认)</span></span><br><span class="line">                    clientFactory.setSessionLocator(<span class="keyword">new</span> KetamaMemcachedSessionLocator());</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">"array"</span>:</span><br><span class="line">                    <span class="comment">// 余数哈希</span></span><br><span class="line">                    clientFactory.setSessionLocator(<span class="keyword">new</span> ArrayMemcachedSessionLocator());</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">"election"</span>:</span><br><span class="line">                    <span class="comment">// 选举哈希</span></span><br><span class="line">                    clientFactory.setSessionLocator(<span class="keyword">new</span> ElectionMemcachedSessionLocator());</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 谁来补充这里的注释, 我不造啊</span></span><br><span class="line">            <span class="keyword">switch</span> (properties.getCommandFactory()) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">"binary"</span>:</span><br><span class="line">                    <span class="comment">// 二进制协议,提高数据传输效率,支持touch等(默认)</span></span><br><span class="line">                    clientFactory.setCommandFactory(<span class="keyword">new</span> BinaryCommandFactory());</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">"kestrel"</span>:</span><br><span class="line">                    clientFactory.setCommandFactory(<span class="keyword">new</span> KestrelCommandFactory());</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">"text"</span>:</span><br><span class="line">                    clientFactory.setCommandFactory(<span class="keyword">new</span> TextCommandFactory());</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> clientFactory;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 创建一个工厂类</span><br><span class="line">     */</span></span><br><span class="line">    <span class="meta">@Configuration</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MemcachedConnectionConfiguration</span> <span class="keyword">extends</span> <span class="title">AbstractMemcachedConfiguration</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> XMemcachedClientFactoryBean <span class="title">memcachedClientFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> applyProperties(<span class="keyword">new</span> XMemcachedClientFactoryBean());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 创建管理器, 用于配合公司基于注解的那套缓存使用方案</span><br><span class="line">     */</span></span><br><span class="line">    <span class="meta">@Configuration</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MemcahchedConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> MemCacheManager <span class="title">memcachedManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> MemCacheManager();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Configuration</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MemcahchedConfiguration1</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> MemCacheManager <span class="title">memcachedManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> MemCacheManager();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Redis配置辅助类"><a href="#Redis配置辅助类" class="headerlink" title="Redis配置辅助类"></a>Redis配置辅助类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisProperties</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span><br><span class="line">    * Database index used by the connection factory.</span><br><span class="line">    */</span></span><br><span class="line">   <span class="meta">@Value</span>(<span class="string">"$&#123;cache.redis.database:0&#125;"</span>)</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">int</span> database;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span><br><span class="line">    * Redis server host.</span><br><span class="line">    */</span></span><br><span class="line">   <span class="meta">@Value</span>(<span class="string">"$&#123;cache.redis.host:localhost&#125;"</span>)</span><br><span class="line">   <span class="keyword">private</span> String host;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span><br><span class="line">    * Login password of the redis server.</span><br><span class="line">    */</span></span><br><span class="line">   <span class="meta">@Value</span>(<span class="string">"$&#123;cache.redis.password:#&#123;null&#125;&#125;"</span>)</span><br><span class="line">   <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span><br><span class="line">    * Redis server port.</span><br><span class="line">    */</span></span><br><span class="line">   <span class="meta">@Value</span>(<span class="string">"$&#123;cache.redis.port:6379&#125;"</span>)</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span><br><span class="line">    * Connection timeout in milliseconds.</span><br><span class="line">    */</span></span><br><span class="line">   <span class="meta">@Value</span>(<span class="string">"$&#123;cache.redis.timeout:300000&#125;"</span>)</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">int</span> timeout;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> Pool pool;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> Sentinel sentinel;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getDatabase</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.database;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// getter and setter</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span><br><span class="line">    * Pool properties.</span><br><span class="line">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Pool</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span><br><span class="line">       * Max number of "idle" connections in the pool. Use a negative value to indicate</span><br><span class="line">       * an unlimited number of idle connections.</span><br><span class="line">       */</span></span><br><span class="line">      <span class="meta">@Value</span>(<span class="string">"$&#123;cache.redis.pool.maxIdle:8&#125;"</span>)</span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">int</span> maxIdle;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span><br><span class="line">       * Target for the minimum number of idle connections to maintain in the pool. This</span><br><span class="line">       * setting only has an effect if it is positive.</span><br><span class="line">       */</span></span><br><span class="line">      <span class="meta">@Value</span>(<span class="string">"$&#123;cache.redis.pool.minIdle:0&#125;"</span>)</span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">int</span> minIdle;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span><br><span class="line">       * Max number of connections that can be allocated by the pool at a given time.</span><br><span class="line">       * Use a negative value for no limit.</span><br><span class="line">       */</span></span><br><span class="line">      <span class="meta">@Value</span>(<span class="string">"$&#123;cache.redis.pool.maxActive:8&#125;"</span>)</span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">int</span> maxActive;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span><br><span class="line">       * Maximum amount of time (in milliseconds) a connection allocation should block</span><br><span class="line">       * before throwing an exception when the pool is exhausted. Use a negative value</span><br><span class="line">       * to block indefinitely.</span><br><span class="line">       */</span></span><br><span class="line">      <span class="meta">@Value</span>(<span class="string">"$&#123;cache.redis.pool.maxWait:-1&#125;"</span>)</span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">int</span> maxWait;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// getter and setter</span></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span><br><span class="line">    * Redis sentinel properties.</span><br><span class="line">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Sentinel</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span><br><span class="line">       * Name of Redis server.</span><br><span class="line">       */</span></span><br><span class="line">      <span class="meta">@Value</span>(<span class="string">"$&#123;cache.redis.sentinel.master:#&#123;null&#125;&#125;"</span>)</span><br><span class="line">      <span class="keyword">private</span> String master;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span><br><span class="line">       * Comma-separated list of host:port pairs.</span><br><span class="line">       */</span></span><br><span class="line">      <span class="meta">@Value</span>(<span class="string">"$&#123;cache.redis.sentinel.nodes:#&#123;null&#125;&#125;"</span>)</span><br><span class="line">      <span class="keyword">private</span> String nodes;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// getter and setter</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Redis自动配置类"><a href="#Redis自动配置类" class="headerlink" title="Redis自动配置类"></a>Redis自动配置类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.msdg.core.cache.impl.RedisCacheManager;</span><br><span class="line"><span class="keyword">import</span> org.msdg.core.conf.autoconfigure.condition.ConditionalOnClass;</span><br><span class="line"><span class="keyword">import</span> org.msdg.core.conf.autoconfigure.condition.ConditionalOnMissingBean;</span><br><span class="line"><span class="keyword">import</span> org.msdg.core.conf.autoconfigure.condition.ConditionalOnMissingClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.pool2.impl.GenericObjectPool;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.RedisConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.RedisNode;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.RedisSentinelConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.jedis.JedisConnection;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.jedis.JedisConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisOperations;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.Assert;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisPoolConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.UnknownHostException;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by mw4157 on 16/7/8.</span><br><span class="line"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass</span>(&#123; JedisConnection.class, RedisOperations.class, Jedis.class &#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisAutoConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"org.springframework.autoconfigure.redis.RedisProperties"</span>)</span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisProperties <span class="title">redisProperties</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RedisProperties();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"org.springframework.autoconfigure.redis.RedisProperties.Pool"</span>)</span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="keyword">public</span> RedisProperties.<span class="function">Pool <span class="title">redisPoolProperties</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RedisProperties.Pool();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"org.springframework.autoconfigure.redis.RedisProperties.Sentinel"</span>)</span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="keyword">public</span> RedisProperties.<span class="function">Sentinel <span class="title">redisSentinelProperties</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RedisProperties.Sentinel();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Base class for Redis configurations.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractRedisConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Autowired</span></span><br><span class="line">        <span class="keyword">protected</span> RedisProperties properties;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Autowired</span>(required = <span class="keyword">false</span>)</span><br><span class="line">        <span class="keyword">private</span> RedisSentinelConfiguration sentinelConfiguration;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> JedisConnectionFactory <span class="title">applyProperties</span><span class="params">(JedisConnectionFactory factory)</span> </span>&#123;</span><br><span class="line">            factory.setHostName(<span class="keyword">this</span>.properties.getHost());</span><br><span class="line">            factory.setPort(<span class="keyword">this</span>.properties.getPort());</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.properties.getPassword() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                factory.setPassword(<span class="keyword">this</span>.properties.getPassword());</span><br><span class="line">            &#125;</span><br><span class="line">            factory.setDatabase(<span class="keyword">this</span>.properties.getDatabase());</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.properties.getTimeout() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                factory.setTimeout(<span class="keyword">this</span>.properties.getTimeout());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> factory;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> RedisSentinelConfiguration <span class="title">getSentinelConfig</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.sentinelConfiguration != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.sentinelConfiguration;</span><br><span class="line">            &#125;</span><br><span class="line">            RedisProperties.Sentinel sentinelProperties = <span class="keyword">this</span>.properties.getSentinel();</span><br><span class="line">            <span class="keyword">if</span> (sentinelProperties.getMaster() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                RedisSentinelConfiguration config = <span class="keyword">new</span> RedisSentinelConfiguration();</span><br><span class="line">                config.master(sentinelProperties.getMaster());</span><br><span class="line">                config.setSentinels(createSentinels(sentinelProperties));</span><br><span class="line">                <span class="keyword">return</span> config;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> List&lt;RedisNode&gt; <span class="title">createSentinels</span><span class="params">(RedisProperties.Sentinel sentinel)</span> </span>&#123;</span><br><span class="line">            List&lt;RedisNode&gt; sentinels = <span class="keyword">new</span> ArrayList&lt;RedisNode&gt;();</span><br><span class="line">            String nodes = sentinel.getNodes();</span><br><span class="line">            <span class="keyword">for</span> (String node : StringUtils.commaDelimitedListToStringArray(nodes)) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    String[] parts = StringUtils.split(node, <span class="string">":"</span>);</span><br><span class="line">                    Assert.state(parts.length == <span class="number">2</span>, <span class="string">"Must be defined as 'host:port'"</span>);</span><br><span class="line">                    sentinels.add(<span class="keyword">new</span> RedisNode(parts[<span class="number">0</span>], Integer.valueOf(parts[<span class="number">1</span>])));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span> (RuntimeException ex) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">                            <span class="string">"Invalid redis sentinel "</span> + <span class="string">"property '"</span> + node + <span class="string">"'"</span>, ex);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> sentinels;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Redis connection configuration.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="meta">@Configuration</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingClass</span>(<span class="string">"org.apache.commons.pool2.impl.GenericObjectPool"</span>)</span><br><span class="line">    <span class="keyword">protected</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisConnectionConfiguration</span> <span class="keyword">extends</span> <span class="title">AbstractRedisConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="meta">@ConditionalOnMissingBean</span>(RedisConnectionFactory.class)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> JedisConnectionFactory <span class="title">redisConnectionFactory</span><span class="params">()</span> <span class="keyword">throws</span> UnknownHostException </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> applyProperties(<span class="keyword">new</span> JedisConnectionFactory(getSentinelConfig()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Redis pooled connection configuration.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="meta">@Configuration</span></span><br><span class="line">    <span class="meta">@ConditionalOnClass</span>(GenericObjectPool.class)</span><br><span class="line">    <span class="keyword">protected</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisPooledConnectionConfiguration</span> <span class="keyword">extends</span> <span class="title">AbstractRedisConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="meta">@ConditionalOnMissingBean</span>(RedisConnectionFactory.class)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> JedisConnectionFactory <span class="title">redisConnectionFactory</span><span class="params">()</span> <span class="keyword">throws</span> UnknownHostException </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> applyProperties(createJedisConnectionFactory());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> JedisConnectionFactory <span class="title">createJedisConnectionFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.properties.getPool() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> JedisConnectionFactory(getSentinelConfig(), jedisPoolConfig());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> JedisConnectionFactory(getSentinelConfig());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> JedisPoolConfig <span class="title">jedisPoolConfig</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            JedisPoolConfig config = <span class="keyword">new</span> JedisPoolConfig();</span><br><span class="line">            RedisProperties.Pool props = <span class="keyword">this</span>.properties.getPool();</span><br><span class="line">            config.setMaxTotal(props.getMaxActive());</span><br><span class="line">            config.setMaxIdle(props.getMaxIdle());</span><br><span class="line">            config.setMinIdle(props.getMinIdle());</span><br><span class="line">            config.setMaxWaitMillis(props.getMaxWait());</span><br><span class="line">            <span class="keyword">return</span> config;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Standard Redis configuration.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="meta">@Configuration</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="meta">@ConditionalOnMissingBean</span>(name = <span class="string">"redisTemplate"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> RedisTemplate&lt;Object, Object&gt; <span class="title">redisTemplate</span><span class="params">(</span><br><span class="line">                RedisConnectionFactory redisConnectionFactory)</span></span><br><span class="line">                <span class="keyword">throws</span> UnknownHostException </span>&#123;</span><br><span class="line">            RedisTemplate&lt;Object, Object&gt; template = <span class="keyword">new</span> RedisTemplate&lt;Object, Object&gt;();</span><br><span class="line">            template.setConnectionFactory(redisConnectionFactory);</span><br><span class="line">            <span class="keyword">return</span> template;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="meta">@ConditionalOnMissingBean</span>(RedisCacheManager.class)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> RedisCacheManager <span class="title">redisCacheManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> RedisCacheManager();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ImportSelector"><a href="#ImportSelector" class="headerlink" title="ImportSelector"></a>ImportSelector</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedHashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.BeansException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.BeanClassLoaderAware;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.BeanFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.BeanFactoryAware;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.config.ConfigurableListableBeanFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.EnvironmentAware;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ResourceLoaderAware;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.DeferredImportSelector;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.Ordered;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.annotation.Order;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.env.Environment;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.ResourceLoader;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.support.SpringFactoriesLoader;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.type.AnnotationMetadata;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.Assert;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Order</span>(Ordered.LOWEST_PRECEDENCE - <span class="number">1</span>)</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EnableAutoConfigurationImportSelector</span> <span class="keyword">implements</span> <span class="title">DeferredImportSelector</span>,</span><br><span class="line">      <span class="title">BeanClassLoaderAware</span>, <span class="title">ResourceLoaderAware</span>, <span class="title">BeanFactoryAware</span>, <span class="title">EnvironmentAware</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> ConfigurableListableBeanFactory beanFactory;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> Environment environment;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> ClassLoader beanClassLoader;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> ResourceLoader resourceLoader;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> String[] selectImports(AnnotationMetadata metadata) &#123;</span><br><span class="line">      List&lt;String&gt; configurations = getCandidateConfigurations();</span><br><span class="line">      configurations = removeDuplicates(configurations);</span><br><span class="line">      <span class="keyword">return</span> configurations.toArray(<span class="keyword">new</span> String[configurations.size()]);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> List&lt;String&gt; <span class="title">getCandidateConfigurations</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> SpringFactoriesLoader.loadFactoryNames(<span class="keyword">this</span>.getClass(), getBeanClassLoader());</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">protected</span> <span class="keyword">final</span> &lt;T&gt; <span class="function">List&lt;T&gt; <span class="title">removeDuplicates</span><span class="params">(List&lt;T&gt; list)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> ArrayList&lt;T&gt;(<span class="keyword">new</span> LinkedHashSet&lt;T&gt;(list));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBeanFactory</span><span class="params">(BeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">      Assert.isInstanceOf(ConfigurableListableBeanFactory.class, beanFactory);</span><br><span class="line">      <span class="keyword">this</span>.beanFactory = (ConfigurableListableBeanFactory) beanFactory;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBeanClassLoader</span><span class="params">(ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.beanClassLoader = classLoader;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> ClassLoader <span class="title">getBeanClassLoader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.beanClassLoader;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEnvironment</span><span class="params">(Environment environment)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.environment = environment;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setResourceLoader</span><span class="params">(ResourceLoader resourceLoader)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.resourceLoader = resourceLoader;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ConditionalOnClass"><a href="#ConditionalOnClass" class="headerlink" title="ConditionalOnClass"></a>ConditionalOnClass</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.annotation.Documented;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.ElementType;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.RetentionPolicy;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Conditional;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * &#123;<span class="doctag">@link</span> Conditional&#125; that only matches when the specified classes are on the classpath.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@author</span> Phillip Webb</span><br><span class="line"> */</span></span><br><span class="line"><span class="meta">@Target</span>(&#123; ElementType.TYPE, ElementType.METHOD &#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Conditional</span>(OnClassCondition.class)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> ConditionalOnClass &#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span><br><span class="line">    * The classes that must be present. Since this annotation parsed by loading class</span><br><span class="line">    * bytecode it is safe to specify classes here that may ultimately not be on the</span><br><span class="line">    * classpath.</span><br><span class="line">    * <span class="doctag">@return</span> the classes that must be present</span><br><span class="line">    */</span></span><br><span class="line">   Class&lt;?&gt;[] value() <span class="keyword">default</span> &#123; &#125;;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span><br><span class="line">    * The classes names that must be present.</span><br><span class="line">    * <span class="doctag">@return</span> the class names that must be present.</span><br><span class="line">    */</span></span><br><span class="line">   String[] name() <span class="keyword">default</span> &#123; &#125;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="OnClassCondition"><a href="#OnClassCondition" class="headerlink" title="OnClassCondition"></a>OnClassCondition</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Condition;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ConditionContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.type.AnnotatedTypeMetadata;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.ClassUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.MultiValueMap;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * &#123;<span class="doctag">@link</span> Condition&#125; that checks for the presence or absence of specific classes.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@author</span> Phillip Webb</span><br><span class="line"> * <span class="doctag">@see</span> ConditionalOnClass</span><br><span class="line"> * <span class="doctag">@see</span> ConditionalOnMissingClass</span><br><span class="line"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OnClassCondition</span> <span class="keyword">implements</span> <span class="title">Condition</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(OnClassCondition.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(ConditionContext conditionContext, AnnotatedTypeMetadata annotatedTypeMetadata)</span> </span>&#123;</span><br><span class="line">        MultiValueMap&lt;String, Object&gt; onClasses = getAttributes(annotatedTypeMetadata,</span><br><span class="line">                ConditionalOnClass.class);</span><br><span class="line">        <span class="keyword">if</span> (onClasses != <span class="keyword">null</span>) &#123;</span><br><span class="line">            List&lt;String&gt; missing = getMatchingClasses(onClasses, MatchType.MISSING, conditionContext);</span><br><span class="line">            <span class="keyword">if</span> (!missing.isEmpty()) &#123;</span><br><span class="line"></span><br><span class="line">                logger.debug(<span class="string">"required @ConditionalOnClass classes not found: &#123;&#125;"</span>,</span><br><span class="line">                        StringUtils.collectionToCommaDelimitedString(missing));</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            logger.debug(<span class="string">"@ConditionalOnClass classes found: &#123;&#125;"</span>,</span><br><span class="line">                    StringUtils.collectionToCommaDelimitedString(</span><br><span class="line">                            getMatchingClasses(onClasses, MatchType.PRESENT, conditionContext)));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        MultiValueMap&lt;String, Object&gt; onMissingClasses = getAttributes(annotatedTypeMetadata,</span><br><span class="line">                ConditionalOnMissingClass.class);</span><br><span class="line">        <span class="keyword">if</span> (onMissingClasses != <span class="keyword">null</span>) &#123;</span><br><span class="line">            List&lt;String&gt; present = getMatchingClasses(onMissingClasses, MatchType.PRESENT, conditionContext);</span><br><span class="line">            <span class="keyword">if</span> (!present.isEmpty()) &#123;</span><br><span class="line">                logger.debug(<span class="string">"required @ConditionalOnMissing classes found: &#123;&#125;"</span>,</span><br><span class="line">                        StringUtils.collectionToCommaDelimitedString(present));</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            logger.debug(<span class="string">"@ConditionalOnMissing classes not found: &#123;&#125;"</span>,</span><br><span class="line">                    StringUtils.collectionToCommaDelimitedString(</span><br><span class="line">                            getMatchingClasses(onMissingClasses, MatchType.MISSING, conditionContext)));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> MultiValueMap&lt;String, Object&gt; <span class="title">getAttributes</span><span class="params">(AnnotatedTypeMetadata metadata,</span><br><span class="line">                                                        Class&lt;?&gt; annotationType)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> metadata.getAllAnnotationAttributes(annotationType.getName(), <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> List&lt;String&gt; <span class="title">getMatchingClasses</span><span class="params">(MultiValueMap&lt;String, Object&gt; attributes,</span><br><span class="line">                                            MatchType matchType, ConditionContext context)</span> </span>&#123;</span><br><span class="line">        List&lt;String&gt; matches = <span class="keyword">new</span> LinkedList&lt;String&gt;();</span><br><span class="line">        addAll(matches, attributes.get(<span class="string">"value"</span>));</span><br><span class="line">        addAll(matches, attributes.get(<span class="string">"name"</span>));</span><br><span class="line">        Iterator&lt;String&gt; iterator = matches.iterator();</span><br><span class="line">        <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!matchType.matches(iterator.next(), context)) &#123;</span><br><span class="line">                iterator.remove();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> matches;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addAll</span><span class="params">(List&lt;String&gt; list, List&lt;Object&gt; itemsToAdd)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (itemsToAdd != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Object item : itemsToAdd) &#123;</span><br><span class="line">                Collections.addAll(list, (String[]) item);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">enum</span> MatchType &#123;</span><br><span class="line">        PRESENT &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(String className, ConditionContext context)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> ClassUtils.isPresent(className, context.getClassLoader());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line"></span><br><span class="line">        MISSING &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(String className, ConditionContext context)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> !ClassUtils.isPresent(className, context.getClassLoader());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(String className, ConditionContext context)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
  </div>
</article>

<section class="reward">
	<a class="btn-reward dashang" href="#">打赏</a>
	<div class="reward-wrapper clearfix">
		<img src="/images/dashang.png" title="微信">
	</div>
</section>


	<div id="lv-container" data-id="city" data-uid="MTAyMC8yOTczMS82Mjk3"></div>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#问题"><span class="toc-number">1.</span> <span class="toc-text">问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#终焉"><span class="toc-number">2.</span> <span class="toc-text">终焉</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#赘述"><span class="toc-number">3.</span> <span class="toc-text">赘述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#有条件的创建"><span class="toc-number">3.1.</span> <span class="toc-text">有条件的创建</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#注解-Conditional"><span class="toc-number">3.1.1.</span> <span class="toc-text">注解 @Conditional</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#接口-Condition"><span class="toc-number">3.1.2.</span> <span class="toc-text">接口 Condition</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#参数-ConditionContext"><span class="toc-number">3.1.2.1.</span> <span class="toc-text">参数 ConditionContext</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#AnnotatedTypeMetadata"><span class="toc-number">3.1.2.2.</span> <span class="toc-text">AnnotatedTypeMetadata</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#尝试自动配置"><span class="toc-number">3.2.</span> <span class="toc-text">尝试自动配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#判断条件"><span class="toc-number">3.2.1.</span> <span class="toc-text">判断条件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#编写自动配置类"><span class="toc-number">3.2.2.</span> <span class="toc-text">编写自动配置类</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#赘述2-0"><span class="toc-number">4.</span> <span class="toc-text">赘述2.0</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#问题1-配置文件"><span class="toc-number">4.1.</span> <span class="toc-text">问题1.配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#问题2-自动配置的类加载"><span class="toc-number">4.2.</span> <span class="toc-text">问题2.自动配置的类加载</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Configuration"><span class="toc-number">4.2.1.</span> <span class="toc-text">@Configuration</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#component-scan"><span class="toc-number">4.2.2.</span> <span class="toc-text">component-scan</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用Selector加载Bean"><span class="toc-number">4.2.3.</span> <span class="toc-text">使用Selector加载Bean</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#编写我们的ImportSelector"><span class="toc-number">4.2.4.</span> <span class="toc-text">编写我们的ImportSelector</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用-Import注册Bean"><span class="toc-number">4.2.5.</span> <span class="toc-text">使用@Import注册Bean</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#结语"><span class="toc-number">5.</span> <span class="toc-text">结语</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PS"><span class="toc-number">6.</span> <span class="toc-text">PS:</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Memchached配置辅助类"><span class="toc-number">6.0.1.</span> <span class="toc-text">Memchached配置辅助类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Memcached自动配置类"><span class="toc-number">6.0.2.</span> <span class="toc-text">Memcached自动配置类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Redis配置辅助类"><span class="toc-number">6.0.3.</span> <span class="toc-text">Redis配置辅助类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Redis自动配置类"><span class="toc-number">6.0.4.</span> <span class="toc-text">Redis自动配置类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ImportSelector"><span class="toc-number">6.0.5.</span> <span class="toc-text">ImportSelector</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ConditionalOnClass"><span class="toc-number">6.0.6.</span> <span class="toc-text">ConditionalOnClass</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#OnClassCondition"><span class="toc-number">6.0.7.</span> <span class="toc-text">OnClassCondition</span></a></li></ol></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://dm4157.github.io/2016/07/14/boot1/"><i class="fa fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://dm4157.github.io/2016/07/14/boot1/&text=参照SpringBoot的自动配置"><i class="fa fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li class="icon bdsharebuttonbox"><a href="javascript:void(0)" data-cmd="weixin" id="wexin" class="fa fa-comments bds_weixin" aria-hidden="true"></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://dm4157.github.io/2016/07/14/boot1/&title=参照SpringBoot的自动配置"><i class="fa fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=参照SpringBoot的自动配置&body=Check out this article: http://dm4157.github.io/2016/07/14/boot1/"><i class="fa fa-envelope fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
      <ul>
        <li id="toc"><a class="icon" href="#" onclick='$("#toc-footer").toggle();return false;'><i class="fa fa-list fa-lg" aria-hidden="true"></i> TOC</a></li>
        <li id="share"><a class="icon" href="#" onclick='$("#share-footer").toggle();return false;'><i class="fa fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></li>
        <li id="top" style="display:none"><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></li>
        <li id="menu"><a class="icon" href="#" onclick='$("#nav-footer").toggle();return false;'><i class="fa fa-bars fa-lg" aria-hidden="true"></i> Menu</a></li>
      </ul>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2017 殇月陨
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

<!-- 来比力评论 -->
<script type="text/javascript">
   (function(d, s) {
       var j, e = d.getElementsByTagName(s)[0];

       if (typeof LivereTower === 'function') { return; }

       j = d.createElement(s);
       j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
       j.async = true;

       e.parentNode.insertBefore(j, e);
   })(document, 'script');
</script>
<!-- 百度分享 -->
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"2","bdSize":"16"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>
</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
<link rel="stylesheet" href="/lib/meslo-LG/styles.css">
<link rel="stylesheet" href="/lib/justified-gallery/justifiedGallery.min.css">


<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- Google Analytics -->

    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-103162179-1', 'auto');
        ga('send', 'pageview');
    </script>

<!-- Disqus Comments -->


