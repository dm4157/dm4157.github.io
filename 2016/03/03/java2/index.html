<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="故事
导报表，会宕机，勿动！

这是发生在我系统中的故（shi）事（gu）。报表导出是很稀松平常的功能，随便搞搞就好。然而当导出量增大时，问题可能就棘手了。我系统中常有20W左右的报表导出，导出时CPU一路高歌、内存余额紧缺，最终结果往往是这样的：

CPU过高导致memcached客户端连接超时，系统宕机；
内存余额清零OOM，系统宕机；
系统心情好，顺产~；

最近第一条故障频发，心力交瘁，疲">
<meta property="og:type" content="article">
<meta property="og:title" content="Excel导出">
<meta property="og:url" content="http://dm4157.github.io/2016/03/03/java2/index.html">
<meta property="og:site_name" content="蝉羽">
<meta property="og:description" content="故事
导报表，会宕机，勿动！

这是发生在我系统中的故（shi）事（gu）。报表导出是很稀松平常的功能，随便搞搞就好。然而当导出量增大时，问题可能就棘手了。我系统中常有20W左右的报表导出，导出时CPU一路高歌、内存余额紧缺，最终结果往往是这样的：

CPU过高导致memcached客户端连接超时，系统宕机；
内存余额清零OOM，系统宕机；
系统心情好，顺产~；

最近第一条故障频发，心力交瘁，疲">
<meta property="og:image" content="http://7xrbi6.com1.z0.glb.clouddn.com/img-old-392-10.png">
<meta property="og:image" content="http://7xrbi6.com1.z0.glb.clouddn.com/img-new-392-10.png">
<meta property="og:image" content="http://7xrbi6.com1.z0.glb.clouddn.com/img-old-11812-10.png">
<meta property="og:image" content="http://7xrbi6.com1.z0.glb.clouddn.com/img-new-11812-10.png">
<meta property="og:image" content="http://7xrbi6.com1.z0.glb.clouddn.com/img-old-96437-13.png">
<meta property="og:image" content="http://7xrbi6.com1.z0.glb.clouddn.com/img-new-96437-10.png">
<meta property="og:image" content="http://7xrbi6.com1.z0.glb.clouddn.com/img-old-271658-10.png">
<meta property="og:image" content="http://7xrbi6.com1.z0.glb.clouddn.com/img-new-271658-10.png">
<meta property="og:image" content="http://7xrbi6.com1.z0.glb.clouddn.com/img-old-448750-1-%E5%B4%A9%E6%BA%83.png">
<meta property="og:image" content="http://7xrbi6.com1.z0.glb.clouddn.com/img-new-448750-10.png">
<meta property="og:image" content="http://7xrbi6.com1.z0.glb.clouddn.com/img-old-601248-1-%E5%B4%A9%E6%BA%83.png">
<meta property="og:image" content="http://7xrbi6.com1.z0.glb.clouddn.com/img-new-601248-10.png">
<meta property="og:image" content="http://7xrbi6.com1.z0.glb.clouddn.com/img-new-1012896-10.png">
<meta property="og:updated_time" content="2017-07-25T07:12:02.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Excel导出">
<meta name="twitter:description" content="故事
导报表，会宕机，勿动！

这是发生在我系统中的故（shi）事（gu）。报表导出是很稀松平常的功能，随便搞搞就好。然而当导出量增大时，问题可能就棘手了。我系统中常有20W左右的报表导出，导出时CPU一路高歌、内存余额紧缺，最终结果往往是这样的：

CPU过高导致memcached客户端连接超时，系统宕机；
内存余额清零OOM，系统宕机；
系统心情好，顺产~；

最近第一条故障频发，心力交瘁，疲">
<meta name="twitter:image" content="http://7xrbi6.com1.z0.glb.clouddn.com/img-old-392-10.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/my.jpg">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/my.jpg" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/my.jpg">
          
        
    
    <!-- title -->
    <title>Excel导出</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- rss -->
    
    
</head>

<body>
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2016/03/04/git1/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li>
        
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li>
        <li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://dm4157.github.io/2016/03/03/java2/"><i class="fa fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://dm4157.github.io/2016/03/03/java2/&text=Excel导出"><i class="fa fa-twitter " aria-hidden="true"></i></a></li>
  <li class="icon bdsharebuttonbox"><a href="javascript:void(0)" data-cmd="weixin" id="wexin" class="fa fa-comments bds_weixin" aria-hidden="true"></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://dm4157.github.io/2016/03/03/java2/&title=Excel导出"><i class="fa fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Excel导出&body=Check out this article: http://dm4157.github.io/2016/03/03/java2/"><i class="fa fa-envelope " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#故事"><span class="toc-number">1.</span> <span class="toc-text">故事</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#硬币的两面"><span class="toc-number">2.</span> <span class="toc-text">硬币的两面</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#产品"><span class="toc-number">2.1.</span> <span class="toc-text">产品</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#技术"><span class="toc-number">2.2.</span> <span class="toc-text">技术</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#技术篇"><span class="toc-number">3.</span> <span class="toc-text">技术篇</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#基础"><span class="toc-number">3.1.</span> <span class="toc-text">基础</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#“大数据”"><span class="toc-number">3.2.</span> <span class="toc-text">“大数据”</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#新玩法"><span class="toc-number">3.3.</span> <span class="toc-text">新玩法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#核心方法"><span class="toc-number">3.4.</span> <span class="toc-text">核心方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#实体要求"><span class="toc-number">3.5.</span> <span class="toc-text">实体要求</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Excel"><span class="toc-number">3.5.1.</span> <span class="toc-text">@Excel</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Column"><span class="toc-number">3.5.2.</span> <span class="toc-text">@Column</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#实体例子"><span class="toc-number">3.5.3.</span> <span class="toc-text">实体例子</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#用起来，少年郎"><span class="toc-number">3.6.</span> <span class="toc-text">用起来，少年郎</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#更多玩法"><span class="toc-number">3.7.</span> <span class="toc-text">更多玩法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#性能"><span class="toc-number">4.</span> <span class="toc-text">性能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#不同数量导出的新旧对比"><span class="toc-number">4.1.</span> <span class="toc-text">不同数量导出的新旧对比</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#392条导出10次"><span class="toc-number">4.1.1.</span> <span class="toc-text">392条导出10次</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#11812条导出10次"><span class="toc-number">4.1.2.</span> <span class="toc-text">11812条导出10次</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#96437条导出10次"><span class="toc-number">4.1.3.</span> <span class="toc-text">96437条导出10次</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#271658条导出10次"><span class="toc-number">4.1.4.</span> <span class="toc-text">271658条导出10次</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#448750条导出10次"><span class="toc-number">4.1.5.</span> <span class="toc-text">448750条导出10次</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#601248条导出10次"><span class="toc-number">4.1.6.</span> <span class="toc-text">601248条导出10次</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1012896条导出10次"><span class="toc-number">4.1.7.</span> <span class="toc-text">1012896条导出10次</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#看图说话"><span class="toc-number">4.2.</span> <span class="toc-text">看图说话</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#缺陷与展望"><span class="toc-number">5.</span> <span class="toc-text">缺陷与展望</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index width mx-auto px2 my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Excel导出
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">殇月陨</span>
      </span>
      
    <div class="postdate">
        <time datetime="2016-03-03T06:02:59.000Z" itemprop="datePublished">2016-03-03</time>
    </div>


      
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/excel/">excel</a>, <a class="tag-link" href="/tags/java/">java</a>, <a class="tag-link" href="/tags/magic/">magic</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="故事"><a href="#故事" class="headerlink" title="故事"></a>故事</h2><blockquote>
<p>导报表，会宕机，勿动！</p>
</blockquote>
<p>这是发生在我系统中的故（shi）事（gu）。报表导出是很稀松平常的功能，随便搞搞就好。然而当导出量增大时，问题可能就棘手了。<br>我系统中常有20W左右的报表导出，导出时CPU一路高歌、内存余额紧缺，最终结果往往是这样的：</p>
<ul>
<li>CPU过高导致memcached客户端连接超时，系统<strong>宕机</strong>；</li>
<li>内存余额清零<code>OOM</code>，系统<strong>宕机</strong>；</li>
<li>系统心情好，顺产~；</li>
</ul>
<p>最近第一条故障频发，心力交瘁，疲于应付。痛定思痛，是时候梳理下报表导出了。</p>
<h2 id="硬币的两面"><a href="#硬币的两面" class="headerlink" title="硬币的两面"></a>硬币的两面</h2><blockquote>
<p>产品与技术是一个硬币的两面。  – 邓爷爷</p>
</blockquote>
<h3 id="产品"><a href="#产品" class="headerlink" title="产品"></a>产品</h3><p>报表导出产品设计通常简单随意，不妨重新思考下极限与体验：</p>
<ul>
<li>产品上对导出极限值进行限制，避免系统<strong>宕机</strong>；比如时间范围限制、最终结果限制；</li>
<li>在导出时进行二次确认，保证用户执行了正确的报表导出动作，避免无意义的导出操作；</li>
<li>精心筛选导出字段，避免不必要的字段增加导出负担；</li>
</ul>
<h3 id="技术"><a href="#技术" class="headerlink" title="技术"></a>技术</h3><p>报表导出开发技术通常简单粗暴， 不妨重新思考下效率与健壮：</p>
<ul>
<li>内在导出上限设置，超出报错；</li>
<li>性能更优的代码，或者更适合业务的代码；比如有的方法适合小数据量导出，有的则适合大量导出；</li>
<li>解决问题的思路是否可以变换一下，比如需要导出的数据分页查出，逐批写入；</li>
</ul>
<hr>
<h2 id="技术篇"><a href="#技术篇" class="headerlink" title="技术篇"></a>技术篇</h2><h3 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h3><blockquote>
<p>Excel导出常见工具包为POI和JXL,功能上POI更多些，然而我也用不上，其实我是看牌子的，POI是Apache家的。</p>
</blockquote>
<p>POI采用了较好的面向对象的思想，Excel表格中的一些概念都变成了类，<br>比如工作簿(<code>WorkBook</code>)、工作表(<code>Sheet</code>)、行(<code>Row</code>)、单元格(<code>Cell</code>)。<br>创建一个Excel文件的基本步骤是这样的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建工作簿 2003版的, .xls</span></span><br><span class="line">Workbook wb = <span class="keyword">new</span> HSSFWorkbook();</span><br><span class="line"><span class="comment">// 2007以后, .xlsx</span></span><br><span class="line"><span class="comment">// Workbook wb = new XSSFWorkbook();</span></span><br><span class="line">CreationHelper createHelper = wb.getCreationHelper();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用工作簿创建工作表</span></span><br><span class="line">Sheet sheet = wb.createSheet(<span class="string">"new sheet"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用工作表创建行, 参数是行号, 从0开始</span></span><br><span class="line">Row row = sheet.createRow((<span class="keyword">short</span>) <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用行创建单元格, 参数是列号, 从0开始</span></span><br><span class="line">Cell cell = row.createCell(<span class="number">0</span>);</span><br><span class="line">cell.setCellValue(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">row.createCell(<span class="number">1</span>).setCellValue(<span class="number">1.2</span>);</span><br><span class="line">row.createCell(<span class="number">2</span>).setCellValue(</span><br><span class="line">        createHelper.createRichTextString(<span class="string">"This is a string"</span>));</span><br><span class="line">row.createCell(<span class="number">3</span>).setCellValue(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">FileOutputStream fileOut = <span class="keyword">new</span> FileOutputStream(<span class="string">"workbook.xls"</span>);</span><br><span class="line"><span class="comment">// 调用工作簿write方法写入流</span></span><br><span class="line">wb.write(fileOut);</span><br><span class="line">fileOut.close();</span><br></pre></td></tr></table></figure>
<p>导入导出不同之处就是一个读一个写（废话）， 简单用用还是不难</p>
<blockquote>
<p>PS. Excel2003版最大行数是65536行，Excel2007开始的版本最大行数是1048576行</p>
</blockquote>
<h3 id="“大数据”"><a href="#“大数据”" class="headerlink" title="“大数据”"></a>“大数据”</h3><p>当数据量激增，达到几万几十万的时候，导出似乎就没那么简单了。如何应对“大数据”对内存的冲击？使用<code>SXSSFWorkbook</code>即可</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 内存中只驻留100行数据</span></span><br><span class="line">SXSSFWorkbook workbook = <span class="keyword">new</span> SXSSFWorkbook(<span class="number">100</span>);</span><br></pre></td></tr></table></figure>
<p>据说<code>SXSSFWorkbook</code>采用流式写法，可以将多余的数据写到磁盘临时文件中去，从而保证内存的安全。<br>但有了好处自然麻烦（平衡之道），使用结束时记得<strong>销毁</strong>临时文件。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 内存中只驻留100行数据</span></span><br><span class="line">SXSSFWorkbook workbook = <span class="keyword">new</span> SXSSFWorkbook(<span class="number">100</span>);</span><br><span class="line">...</span><br><span class="line">workbook.dispose();</span><br></pre></td></tr></table></figure>
<p>至于缓存100行还是1000行，这需要自己去尝试，我也是在路上。</p>
<h3 id="新玩法"><a href="#新玩法" class="headerlink" title="新玩法"></a>新玩法</h3><blockquote>
<p>每次导出Excel，都需要去编写特定的导出逻辑么？</p>
<p>担心<em>大数据量</em>导出时的性能损耗么？</p>
<p>现推出新式玩法，简单高效，已加入肯德基豪华午餐；</p>
</blockquote>
<h3 id="核心方法"><a href="#核心方法" class="headerlink" title="核心方法"></a>核心方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * 针对只参与一张excel导出的实体,可使用此方法</span><br><span class="line"> * 即实体上只有一个<span class="doctag">@Excel</span>注解</span><br><span class="line"> * <span class="doctag">@param</span> response</span><br><span class="line"> * <span class="doctag">@param</span> data          将要导出的数据</span><br><span class="line"> * <span class="doctag">@param</span> modelClass    数据的实体类型信息, 需要使用<span class="doctag">@Excel</span></span><br><span class="line"> * <span class="doctag">@param</span> &lt;T&gt;           实体泛型</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">exportToExcel</span><span class="params">(HttpServletResponse response, List&lt;T&gt; data, Class&lt;T&gt; modelClass)</span></span></span><br></pre></td></tr></table></figure>
<ul>
<li>response来自Controller, 导出怎么能少了他；</li>
<li>data即是需要导出的数据列表，自己写查询语句；</li>
<li>modelClass是数据列表中放的核心实体，即要导出的对象</li>
</ul>
<h3 id="实体要求"><a href="#实体要求" class="headerlink" title="实体要求"></a>实体要求</h3><blockquote>
<p>平衡之道告诉我们，想得到先付出。</p>
</blockquote>
<p>作为被导出的实体，需要提前注册下面两个注解。</p>
<h4 id="Excel"><a href="#Excel" class="headerlink" title="@Excel"></a>@Excel</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Excel &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 导出的文件叫什么? */</span></span><br><span class="line">    String[] value() <span class="keyword">default</span> <span class="string">"没有名字的导出表"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 最大导出条数 */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">limit</span><span class="params">()</span> <span class="keyword">default</span> 1040000</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Column"><a href="#Column" class="headerlink" title="@Column"></a>@Column</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(ElementType.FIELD)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Repeatable</span>(Columns.class)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Column&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** excel列名,就是表头 */</span></span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 列表排序, 小号在前面, 默认的话就按实体里字段顺序了 */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">index</span><span class="params">()</span> <span class="keyword">default</span> 0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 属于哪个<span class="doctag">@Excel</span>, 填<span class="doctag">@Excel</span>.value */</span></span><br><span class="line">    String[] belong() <span class="keyword">default</span> <span class="string">""</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="实体例子"><a href="#实体例子" class="headerlink" title="实体例子"></a>实体例子</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导出文件名为《账号管理_费用记录.xlsx》,</span></span><br><span class="line"><span class="comment">// 最大条数限制为90w，超出后报ExcelException</span></span><br><span class="line"><span class="meta">@Excel</span>(value = <span class="string">"账号管理_费用记录"</span>, limit = <span class="number">900000</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VExpenseDetail</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column</span>(<span class="string">"网站ID"</span>)</span><br><span class="line">    <span class="keyword">private</span> String webAccountId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 导出后将排在`网站ID`之前</span></span><br><span class="line">    <span class="meta">@Column</span>(value = <span class="string">"网站"</span>, index = -<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">private</span> String webName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 导出后列名为字段名即`actionName`</span></span><br><span class="line">    <span class="meta">@Column</span></span><br><span class="line">    <span class="keyword">private</span> String actionName;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="用起来，少年郎"><a href="#用起来，少年郎" class="headerlink" title="用起来，少年郎"></a>用起来，少年郎</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> ExcelHandler excelHandler;</span><br><span class="line">...</span><br><span class="line">List&lt;VExpenseDetail&gt; exportData = actionService.queryFeeRecord(paraMap);</span><br><span class="line">excelHandler.exportToExcel(response, exportData, VExpenseDetail.class);</span><br></pre></td></tr></table></figure>
<h3 id="更多玩法"><a href="#更多玩法" class="headerlink" title="更多玩法"></a>更多玩法</h3><p>通常，我们不会为导出某张报表创造一个新类，如果一个业务实体面临多张报表导出，该如何？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 实体支持两张表导出</span></span><br><span class="line"><span class="meta">@Excel</span>(value = &#123;<span class="string">"账号管理_费用记录"</span>, <span class="string">"操作记录"</span>&#125;, limit = <span class="number">900000</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VExpenseDetail</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 默认会在两张表里都出现</span></span><br><span class="line">    <span class="meta">@Column</span>(<span class="string">"网站ID"</span>)</span><br><span class="line">    <span class="keyword">private</span> String webAccountId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 与上面的默认没什么区别， 两张表都有此字段</span></span><br><span class="line">    <span class="meta">@Column</span>(value = <span class="string">"网站"</span>, belong = &#123;<span class="string">"账号管理_费用记录"</span>, <span class="string">"操作记录"</span>&#125;)</span><br><span class="line">    <span class="keyword">private</span> String webName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 两张表都有此字段，但有不同的列名</span></span><br><span class="line">    <span class="comment">// ** 不建议此做法，同样的字段应该具有同样的含义，不论身处何地 **</span></span><br><span class="line">    <span class="meta">@Column</span>(value = <span class="string">"费用类型"</span>, belong = <span class="string">"账号管理_费用记录"</span>)</span><br><span class="line">    <span class="meta">@Column</span>(value = <span class="string">"操作类型"</span>, belong = <span class="string">"操作记录"</span>)</span><br><span class="line">    <span class="keyword">private</span> String actionName;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="性能"><a href="#性能" class="headerlink" title="性能"></a>性能</h2><blockquote>
<p>比较方能出优劣</p>
</blockquote>
<p>这里将上述导出方法与广告系统中的原有导出方法做比较，在同样的条件下看看CPU和内存方面的表现。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">机器配置</span><br><span class="line">CPU i5</span><br><span class="line">内存 8G</span><br><span class="line"></span><br><span class="line">导出表格列数 16</span><br></pre></td></tr></table></figure></p>
<h3 id="不同数量导出的新旧对比"><a href="#不同数量导出的新旧对比" class="headerlink" title="不同数量导出的新旧对比"></a>不同数量导出的新旧对比</h3><blockquote>
<p>old-392-10 =&gt; 旧版-导出392条-10次尝试</p>
</blockquote>
<h4 id="392条导出10次"><a href="#392条导出10次" class="headerlink" title="392条导出10次"></a>392条导出10次</h4><p><strong>old-392-10</strong><br><img src="http://7xrbi6.com1.z0.glb.clouddn.com/img-old-392-10.png" alt="旧版"><br><strong>new-392-10</strong><br><img src="http://7xrbi6.com1.z0.glb.clouddn.com/img-new-392-10.png" alt="新版"></p>
<h4 id="11812条导出10次"><a href="#11812条导出10次" class="headerlink" title="11812条导出10次"></a>11812条导出10次</h4><p><strong>old-11812-10</strong><br><img src="http://7xrbi6.com1.z0.glb.clouddn.com/img-old-11812-10.png" alt="旧版"><br><strong>new-11812-10</strong><br><img src="http://7xrbi6.com1.z0.glb.clouddn.com/img-new-11812-10.png" alt="新版"></p>
<h4 id="96437条导出10次"><a href="#96437条导出10次" class="headerlink" title="96437条导出10次"></a>96437条导出10次</h4><p><strong>old-96437-10</strong><br><img src="http://7xrbi6.com1.z0.glb.clouddn.com/img-old-96437-13.png" alt="旧版"><br><strong>new-96437-10</strong><br><img src="http://7xrbi6.com1.z0.glb.clouddn.com/img-new-96437-10.png" alt="新版"></p>
<h4 id="271658条导出10次"><a href="#271658条导出10次" class="headerlink" title="271658条导出10次"></a>271658条导出10次</h4><p><strong>old-271658-10</strong><br><img src="http://7xrbi6.com1.z0.glb.clouddn.com/img-old-271658-10.png" alt="旧版"><br><strong>new-271658-10</strong><br><img src="http://7xrbi6.com1.z0.glb.clouddn.com/img-new-271658-10.png" alt="新版"></p>
<h4 id="448750条导出10次"><a href="#448750条导出10次" class="headerlink" title="448750条导出10次"></a>448750条导出10次</h4><p><strong>old-448750-1-崩溃</strong><br><img src="http://7xrbi6.com1.z0.glb.clouddn.com/img-old-448750-1-%E5%B4%A9%E6%BA%83.png" alt="旧版"><br><strong>new-448750-10</strong><br><img src="http://7xrbi6.com1.z0.glb.clouddn.com/img-new-448750-10.png" alt="新版"></p>
<h4 id="601248条导出10次"><a href="#601248条导出10次" class="headerlink" title="601248条导出10次"></a>601248条导出10次</h4><p><strong>old-601248-1-崩溃</strong><br><img src="http://7xrbi6.com1.z0.glb.clouddn.com/img-old-601248-1-%E5%B4%A9%E6%BA%83.png" alt="旧版"><br><strong>new-601248-10</strong><br><img src="http://7xrbi6.com1.z0.glb.clouddn.com/img-new-601248-10.png" alt="新版"></p>
<h4 id="1012896条导出10次"><a href="#1012896条导出10次" class="headerlink" title="1012896条导出10次"></a>1012896条导出10次</h4><p><strong>new-1012896-10</strong><br><img src="http://7xrbi6.com1.z0.glb.clouddn.com/img-new-1012896-10.png" alt="新版"></p>
<h3 id="看图说话"><a href="#看图说话" class="headerlink" title="看图说话"></a>看图说话</h3><p>在数据量少（1w以内）， 新旧没有明显的性能差异，旧版在cpu上更优而新版在内存上略胜。<br>但从9w数据量开始，新版的优势就非常明显了，并且随着数据量的增加急剧扩大。<br>老版在44w处崩溃，而新版可以一直导出到接近单页极限值101w（没有继续试验）。<br>结合新版的易用性，我还是喜欢新版（自己的孩子）。</p>
<h2 id="缺陷与展望"><a href="#缺陷与展望" class="headerlink" title="缺陷与展望"></a>缺陷与展望</h2><ul>
<li>只支持单sheet导出，即最大值为1048576条。</li>
<li>不支持设置表格式，比如列宽、字体、颜色等。</li>
<li>可按照同样的逻辑去编写Excel导入方法。</li>
<li>Excel导出时可尝试分页读取数据。<strong>尽请期待</strong></li>
</ul>

  </div>
</article>

<section class="reward">
	<a class="btn-reward dashang" href="#">打赏</a>
	<div class="reward-wrapper clearfix">
		<img src="/images/dashang.png" title="微信">
	</div>
</section>


	<div id="lv-container" data-id="city" data-uid="MTAyMC8yOTczMS82Mjk3"></div>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#故事"><span class="toc-number">1.</span> <span class="toc-text">故事</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#硬币的两面"><span class="toc-number">2.</span> <span class="toc-text">硬币的两面</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#产品"><span class="toc-number">2.1.</span> <span class="toc-text">产品</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#技术"><span class="toc-number">2.2.</span> <span class="toc-text">技术</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#技术篇"><span class="toc-number">3.</span> <span class="toc-text">技术篇</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#基础"><span class="toc-number">3.1.</span> <span class="toc-text">基础</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#“大数据”"><span class="toc-number">3.2.</span> <span class="toc-text">“大数据”</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#新玩法"><span class="toc-number">3.3.</span> <span class="toc-text">新玩法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#核心方法"><span class="toc-number">3.4.</span> <span class="toc-text">核心方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#实体要求"><span class="toc-number">3.5.</span> <span class="toc-text">实体要求</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Excel"><span class="toc-number">3.5.1.</span> <span class="toc-text">@Excel</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Column"><span class="toc-number">3.5.2.</span> <span class="toc-text">@Column</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#实体例子"><span class="toc-number">3.5.3.</span> <span class="toc-text">实体例子</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#用起来，少年郎"><span class="toc-number">3.6.</span> <span class="toc-text">用起来，少年郎</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#更多玩法"><span class="toc-number">3.7.</span> <span class="toc-text">更多玩法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#性能"><span class="toc-number">4.</span> <span class="toc-text">性能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#不同数量导出的新旧对比"><span class="toc-number">4.1.</span> <span class="toc-text">不同数量导出的新旧对比</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#392条导出10次"><span class="toc-number">4.1.1.</span> <span class="toc-text">392条导出10次</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#11812条导出10次"><span class="toc-number">4.1.2.</span> <span class="toc-text">11812条导出10次</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#96437条导出10次"><span class="toc-number">4.1.3.</span> <span class="toc-text">96437条导出10次</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#271658条导出10次"><span class="toc-number">4.1.4.</span> <span class="toc-text">271658条导出10次</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#448750条导出10次"><span class="toc-number">4.1.5.</span> <span class="toc-text">448750条导出10次</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#601248条导出10次"><span class="toc-number">4.1.6.</span> <span class="toc-text">601248条导出10次</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1012896条导出10次"><span class="toc-number">4.1.7.</span> <span class="toc-text">1012896条导出10次</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#看图说话"><span class="toc-number">4.2.</span> <span class="toc-text">看图说话</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#缺陷与展望"><span class="toc-number">5.</span> <span class="toc-text">缺陷与展望</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://dm4157.github.io/2016/03/03/java2/"><i class="fa fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://dm4157.github.io/2016/03/03/java2/&text=Excel导出"><i class="fa fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li class="icon bdsharebuttonbox"><a href="javascript:void(0)" data-cmd="weixin" id="wexin" class="fa fa-comments bds_weixin" aria-hidden="true"></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://dm4157.github.io/2016/03/03/java2/&title=Excel导出"><i class="fa fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Excel导出&body=Check out this article: http://dm4157.github.io/2016/03/03/java2/"><i class="fa fa-envelope fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
      <ul>
        <li id="toc"><a class="icon" href="#" onclick='$("#toc-footer").toggle();return false;'><i class="fa fa-list fa-lg" aria-hidden="true"></i> TOC</a></li>
        <li id="share"><a class="icon" href="#" onclick='$("#share-footer").toggle();return false;'><i class="fa fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></li>
        <li id="top" style="display:none"><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></li>
        <li id="menu"><a class="icon" href="#" onclick='$("#nav-footer").toggle();return false;'><i class="fa fa-bars fa-lg" aria-hidden="true"></i> Menu</a></li>
      </ul>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2017 殇月陨
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

<!-- 来比力评论 -->
<script type="text/javascript">
   (function(d, s) {
       var j, e = d.getElementsByTagName(s)[0];

       if (typeof LivereTower === 'function') { return; }

       j = d.createElement(s);
       j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
       j.async = true;

       e.parentNode.insertBefore(j, e);
   })(document, 'script');
</script>
<!-- 百度分享 -->
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"2","bdSize":"16"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>
</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
<link rel="stylesheet" href="/lib/meslo-LG/styles.css">
<link rel="stylesheet" href="/lib/justified-gallery/justifiedGallery.min.css">


<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- Google Analytics -->

    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-103162179-1', 'auto');
        ga('send', 'pageview');
    </script>

<!-- Disqus Comments -->


